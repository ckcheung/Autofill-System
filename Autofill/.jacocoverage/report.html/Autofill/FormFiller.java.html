<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FormFiller.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;Autofill&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">Autofill</a> &gt; <span class="el_source">FormFiller.java</span></div><h1>FormFiller.java</h1><pre class="source lang-java linenums">package Autofill;

import com.itextpdf.text.DocumentException;
import com.itextpdf.text.Rectangle;
import com.itextpdf.text.pdf.AcroFields;
import com.itextpdf.text.pdf.PdfReader;
import com.itextpdf.text.pdf.PdfStamper;
import com.itextpdf.text.pdf.parser.FilteredTextRenderListener;
import com.itextpdf.text.pdf.parser.LocationTextExtractionStrategy;
import com.itextpdf.text.pdf.parser.PdfTextExtractor;
import com.itextpdf.text.pdf.parser.RegionTextRenderFilter;
import com.itextpdf.text.pdf.parser.RenderFilter;
import com.itextpdf.text.pdf.parser.TextExtractionStrategy;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Set;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

public class FormFiller {

    private ArrayList&lt;AcroFormField&gt; fieldList;
    private String sourceFilePath;
    
<span class="fc" id="L29">    public FormFiller(String filepath) {</span>
<span class="fc" id="L30">        fieldList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L31">        sourceFilePath = filepath;</span>
<span class="fc" id="L32">    }</span>
    
//    public ArrayList&lt;AcroFormField&gt; fillPdf(String dest, String data, Connection con, PreparedStatement pstmt, ResultSet rs) throws IOException, DocumentException, JSONException, SQLException {
    public ArrayList&lt;AcroFormField&gt; fillPdf(String dest, String data) throws IOException, DocumentException, JSONException {
<span class="nc" id="L36">        Dictionary dictionary = Dictionary.getInstance();</span>
<span class="nc" id="L37">        PdfReader reader = new PdfReader(sourceFilePath); </span>
<span class="nc" id="L38">        PdfStamper stamper = new PdfStamper(reader, new FileOutputStream(dest));</span>
<span class="nc" id="L39">        AcroFields form = stamper.getAcroFields();</span>
<span class="nc" id="L40">        Set&lt;String&gt; fields = form.getFields().keySet();</span>
       
        AcroFormField temp;
        
<span class="nc" id="L44">        HashMap objectMap = new HashMap();</span>
        
<span class="nc" id="L46">        HashMap fieldMap = new HashMap();</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        for (String key : fields) {</span>
<span class="nc" id="L48">            temp = new AcroFormField();</span>
<span class="nc" id="L49">            temp.setFieldName(key);</span>
<span class="nc" id="L50">            temp.setPage(form.getFieldPositions(key).get(0).page);</span>
<span class="nc" id="L51">            temp.setPosition(form.getFieldPositions(key).get(0).position);</span>
<span class="nc" id="L52">            fieldList.add(temp);</span>
<span class="nc" id="L53">            objectMap.put(key, temp);</span>
<span class="nc" id="L54">            fieldMap.put(key.toLowerCase(), key);</span>
            //System.out.println(key.toLowerCase());
            //ArrayList&lt;String&gt; samePrefixWords = getSamePrefixWords(key, con);
<span class="nc" id="L57">            ArrayList&lt;String&gt; samePrefixWords = dictionary.getSamePrefixWords(key);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">            for (String samePrefixWord: samePrefixWords) {</span>
<span class="nc" id="L59">                fieldMap.put(samePrefixWord, key);</span>
<span class="nc" id="L60">            }</span>
<span class="nc" id="L61">        }</span>
        
        // Get field label and group
        RenderFilter filter;
        TextExtractionStrategy strategy;
        Rectangle targetArea;
<span class="nc" id="L67">        Collections.sort(fieldList);</span>
<span class="nc" id="L68">        AcroFormField currentField = null;</span>
<span class="nc" id="L69">        AcroFormField previousField = null;</span>
<span class="nc" id="L70">        String group = null;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        for (int i=0; i&lt;fieldList.size(); i++) {</span>
<span class="nc" id="L72">            currentField = fieldList.get(i);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (form.getFieldType(currentField.getFieldName()) == AcroFields.FIELD_TYPE_TEXT) {</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">                if (i&gt;0 &amp;&amp; isSameLinePreviousField(currentField.getPosition(), previousField.getPosition())) {</span>
<span class="nc" id="L75">                    targetArea = new Rectangle(</span>
<span class="nc" id="L76">                        previousField.getPosition().getRight(), // Lower left x</span>
<span class="nc" id="L77">                        currentField.getPosition().getBottom(), // Lower left y</span>
<span class="nc" id="L78">                        currentField.getPosition().getLeft(),   // Upper right x</span>
<span class="nc" id="L79">                        currentField.getPosition().getTop()     // Upper right y</span>
                    );
                } else {
<span class="nc" id="L82">                    targetArea = new Rectangle(</span>
                        0,                                      // lower left x
<span class="nc" id="L84">                        currentField.getPosition().getBottom(), // Lower left y</span>
<span class="nc" id="L85">                        currentField.getPosition().getLeft(),   // Upper right x</span>
<span class="nc" id="L86">                        currentField.getPosition().getTop()     // Upper right y</span>
                    );                    
                }
<span class="nc" id="L89">                filter = new RegionTextRenderFilter(targetArea);</span>
<span class="nc" id="L90">                strategy = new FilteredTextRenderListener(new LocationTextExtractionStrategy(), filter);</span>
<span class="nc" id="L91">                currentField.setFieldValue(form.getField(currentField.getFieldName()));</span>
<span class="nc" id="L92">                currentField.setFieldLabel(PdfTextExtractor.getTextFromPage(reader, currentField.getPage(), strategy));                </span>
            }   

<span class="nc bnc" id="L95" title="All 4 branches missed.">            if (i&gt;0 &amp;&amp; isGrouped(currentField.getPosition(), previousField.getPosition())) {</span>
<span class="nc" id="L96">                targetArea = new Rectangle(</span>
                    0,                                          // lower left x
<span class="nc" id="L98">                    currentField.getPosition().getTop(),        // Lower left y</span>
<span class="nc" id="L99">                    currentField.getPosition().getRight(),      // Upper right x</span>
<span class="nc" id="L100">                    currentField.getPosition().getTop()+currentField.getPosition().getHeight()      // Upper right y</span>
                );
<span class="nc" id="L102">                filter = new RegionTextRenderFilter(targetArea);</span>
<span class="nc" id="L103">                strategy = new FilteredTextRenderListener(new LocationTextExtractionStrategy(), filter);</span>
<span class="nc" id="L104">                String tempGroup = PdfTextExtractor.getTextFromPage(reader, currentField.getPage(), strategy);</span>
                
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (!tempGroup.equals(&quot;&quot;)) {</span>
<span class="nc" id="L107">                    group = tempGroup.split(&quot;\\(&quot;)[0].trim();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (group.split(&quot; &quot;).length&gt;4) {</span>
<span class="nc" id="L109">                        group = &quot;Other&quot;;</span>
                    }
                }
            }
<span class="nc" id="L113">            currentField.setGroup(group);</span>
<span class="nc" id="L114">            previousField = fieldList.get(i);</span>
        }
        
        
<span class="nc" id="L118">        JSONArray dataArray = new JSONArray(data);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        for (int i=0; i&lt;dataArray.length(); i++) {</span>
<span class="nc" id="L120">            boolean matchFound = false;</span>
<span class="nc" id="L121">            JSONObject dataObject = dataArray.getJSONObject(i);</span>
<span class="nc" id="L122">            System.out.println(dataArray.get(i));</span>
            
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (fieldMap.get(dataObject.getString(&quot;name&quot;)) != null) {</span>
                // Exact match
<span class="nc" id="L126">                AcroFormField field = ((AcroFormField)objectMap.get((String)fieldMap.get(dataObject.getString(&quot;name&quot;))));</span>
                // If group match
                //if (isGroupMatch(con, field, dataObject.getString(&quot;group&quot;))) {
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (isGroupMatch(field, dataObject.getString(&quot;group&quot;))) {</span>
<span class="nc" id="L130">                    form.setField((String)fieldMap.get(dataObject.getString(&quot;name&quot;)), dataObject.getString(&quot;value&quot;));</span>
<span class="nc" id="L131">                    field.setPersonalFieldName(dataObject.getString(&quot;name&quot;));</span>
<span class="nc" id="L132">                    matchFound = true;</span>
                }
            }
            
<span class="nc bnc" id="L136" title="All 4 branches missed.">            if (fieldMap.get(dataObject.getString(&quot;name&quot;)) == null &amp;&amp; !matchFound) {    // Search dictionary</span>
                // Get standard field name for synonym
                //String standard = getStandardWord(dataObject.getString(&quot;name&quot;), con);
<span class="nc" id="L139">                String standard = dictionary.getStandardWord(dataObject.getString(&quot;name&quot;));</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (fieldMap.get(standard) != null) {</span>
                    // standard is the key
<span class="nc" id="L142">                    AcroFormField field = ((AcroFormField)objectMap.get((String)fieldMap.get(standard)));</span>
                    // If group match
                    //if (isGroupMatch(con, field, dataObject.getString(&quot;group&quot;))) {
<span class="nc bnc" id="L145" title="All 2 branches missed.">                    if (isGroupMatch(field, dataObject.getString(&quot;group&quot;))) {</span>
<span class="nc" id="L146">                        form.setField((String)fieldMap.get(standard), dataObject.getString(&quot;value&quot;));</span>
<span class="nc" id="L147">                        field.setPersonalFieldName(dataObject.getString(&quot;name&quot;));</span>
                    } 
<span class="nc" id="L149">                } else {</span>
                    // standard is not the key
                    //ArrayList&lt;String&gt; synonyms = getSynonyms(dataObject.getString(&quot;name&quot;), con);
<span class="nc" id="L152">                    ArrayList&lt;String&gt; synonyms = dictionary.getSynonyms(dataObject.getString(&quot;name&quot;));</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                    for (String fieldName: synonyms) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                        if (fieldMap.get(fieldName) != null) {</span>
<span class="nc" id="L155">                            AcroFormField field = ((AcroFormField)objectMap.get((String)fieldMap.get(fieldName)));</span>
                            // If group match
<span class="nc" id="L157">                            System.out.println(field.getFieldLabel() + &quot; &quot; + field.getGroup());</span>
                            //if (isGroupMatch(con, field, dataObject.getString(&quot;group&quot;))) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">                            if (isGroupMatch(field, dataObject.getString(&quot;group&quot;))) {</span>
<span class="nc" id="L160">                                form.setField((String)fieldMap.get(fieldName), dataObject.getString(&quot;value&quot;));</span>
<span class="nc" id="L161">                                field.setPersonalFieldName(dataObject.getString(&quot;name&quot;));</span>
<span class="nc" id="L162">                                System.out.println(fieldName);</span>
<span class="nc" id="L163">                                break;</span>
                            }
                        }
<span class="nc" id="L166">                    }</span>
                }
            }
        }
        
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (int i=0; i&lt;fieldList.size(); i++) {</span>
<span class="nc" id="L172">            currentField = fieldList.get(i);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (form.getFieldType(currentField.getFieldName()) == AcroFields.FIELD_TYPE_TEXT) {</span>
<span class="nc" id="L174">                currentField.setFieldValue(form.getField(currentField.getFieldName()));</span>
            }   
        }
        
<span class="nc" id="L178">        stamper.close();</span>
<span class="nc" id="L179">        reader.close();</span>
        
<span class="nc" id="L181">        return fieldList;</span>
    }
    
    
//    private boolean isGroupMatch(Connection con, AcroFormField field, String group) throws SQLException {
    private boolean isGroupMatch(AcroFormField field, String group) {
<span class="fc" id="L187">        Dictionary dictionary = Dictionary.getInstance();</span>
        String fieldGroup;
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (field.getGroup() == null) {</span>
<span class="fc" id="L190">            fieldGroup = &quot;personal information&quot;;   </span>
        } else {
<span class="fc" id="L192">            fieldGroup = field.getGroup().toLowerCase();   </span>
        }
<span class="fc" id="L194">        String dataGroup = group.toLowerCase();</span>
        //ArrayList&lt;String&gt; groupSynonyms = getSynonyms(fieldGroup, con);
<span class="fc" id="L196">        ArrayList&lt;String&gt; groupSynonyms = dictionary.getSynonyms(fieldGroup);</span>

        // Default group is Perosnal Information
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (dataGroup.equals(&quot;&quot;)) {</span>
<span class="fc" id="L200">            dataGroup = &quot;personal information&quot;;</span>
        }

        // Exact match of Group name 
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (fieldGroup.equals(dataGroup)) {</span>
<span class="fc" id="L205">            return true;</span>
        }
        
        // Match of synonyms
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        for (String groupSynonym : groupSynonyms) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (fieldGroup.equals(groupSynonym)) {</span>
<span class="nc" id="L211">                return true;</span>
            }
<span class="nc" id="L213">        }</span>
        
<span class="fc" id="L215">        return false;</span>
    }
    
    private boolean isSameLinePreviousField(Rectangle curFieldPosition, Rectangle preFieldPosition) {
<span class="pc bpc" id="L219" title="1 of 4 branches missed.">        return isOnRight(curFieldPosition, preFieldPosition) &amp;&amp; isOnSameLine(curFieldPosition, preFieldPosition);</span>
    }
    
    private boolean isOnRight(Rectangle curFieldPosition, Rectangle preFieldPosition) {
<span class="fc bfc" id="L223" title="All 2 branches covered.">        return curFieldPosition.getLeft() &gt; preFieldPosition.getRight();</span>
    }
    
    private boolean isOnSameLine(Rectangle curFieldPosition, Rectangle preFieldPosition) {
<span class="fc" id="L227">        double dy = curFieldPosition.getTop()-preFieldPosition.getTop();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        return  dy &lt; curFieldPosition.getHeight();</span>
    }
    
    private boolean isGrouped(Rectangle curFieldPosition, Rectangle preFieldPosition) {
<span class="pc bpc" id="L232" title="1 of 4 branches missed.">        return !isOnRight(curFieldPosition, preFieldPosition) &amp;&amp; isSeperated(curFieldPosition, preFieldPosition);         </span>
    }
    
    private boolean isSeperated(Rectangle curFieldPosition, Rectangle preFieldPosition) {
<span class="fc" id="L236">        double dy = preFieldPosition.getBottom()-curFieldPosition.getTop();</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">        return dy &gt; curFieldPosition.getHeight();</span>
    }
    
    /*
    private String getStandardWord(String word, Connection dictionaryCon) throws SQLException {
        String standard = &quot;&quot;;
        PreparedStatement pstmt;
        ResultSet rs;
        
        pstmt = dictionaryCon.prepareStatement(
            &quot;SELECT standard FROM Dictionary WHERE synonym = ? ORDER BY probability&quot;
        );
        pstmt.setString(1, word);
        rs = pstmt.executeQuery();
        if (rs.next()) {
            standard = rs.getString(&quot;standard&quot;);
        }
        return standard;
    }
    
    private ArrayList&lt;String&gt; getSynonyms(String word, Connection dictionaryCon) throws SQLException {
        ArrayList&lt;String&gt; synonyms = new ArrayList&lt;&gt;();
        PreparedStatement pstmt;
        ResultSet rs;
        
        String standard = getStandardWord(word, dictionaryCon);
        pstmt = dictionaryCon.prepareStatement(
            &quot;SELECT synonym FROM Dictionary WHERE standard = ? OR standard = ? ORDER BY probability&quot;
        );
        pstmt.setString(1, word);
        pstmt.setString(2, standard); 
        rs = pstmt.executeQuery();
        while (rs.next()) {
            synonyms.add(rs.getString(&quot;synonym&quot;));
        }
        
        return synonyms;
    }
    
    private ArrayList&lt;String&gt; getSamePrefixWords(String word, Connection dictionaryCon) throws SQLException {
        ArrayList&lt;String&gt; samePrefixWords = new ArrayList&lt;&gt;();
        PreparedStatement pstmt;
        ResultSet rs;
        
        // Create search key
        StringBuilder strBuilder = new StringBuilder(word);
        strBuilder.insert(word.length(), &quot;%&quot;);
        for (int i=word.length()-1; i&gt;0; i--) {
            if (Character.isUpperCase(word.charAt(i))) {
                strBuilder.insert(i, &quot; %&quot;);
            }
        }
        String searchKey = strBuilder.toString().toLowerCase();

        pstmt = dictionaryCon.prepareStatement(
            &quot;SELECT standard FROM Dictionary WHERE standard LIKE ?&quot;
        );
        pstmt.setString(1, searchKey);
        rs = pstmt.executeQuery();
        while (rs.next()) {
            samePrefixWords.add(rs.getString(&quot;standard&quot;));
        }

        pstmt = dictionaryCon.prepareStatement(
            &quot;SELECT synonym FROM Dictionary WHERE synonym LIKE ?&quot;
        );
        pstmt.setString(1, searchKey);
        rs = pstmt.executeQuery();
        while (rs.next()) {
            samePrefixWords.add(rs.getString(&quot;synonym&quot;));
        }
        
        return samePrefixWords;
    }
    */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>